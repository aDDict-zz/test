#!/usr/bin/perl

use DBI;

$dbh = DBI->connect('DBI:mysql:maxima:localhost:3306','root','bartok26') || die $DBI::errstr ; 
$dbh->{RaiseError} = 1;
$dbh->do("set names utf8");

@filters = (15108);

for (@filters) {

    $filter_id=$_;
    $group_name="permission";
    $group_id=543;

    $filter_error="filter_ok";
    $filtres="";
    open FILTER, "/usr/local/maxima/filter_engine $filter_id|";
    while (<FILTER>) {
        $filtres .= $_;
    }
    close (FILTER);
    @filtarr = split /\n/,$filtres;
    if ($filtarr[0] eq "filter_ok") {
            $filter_query=$filtarr[1];
            $limitord=$filtarr[2];
            $limitnum=$filtarr[3];
            $syntax_error=$filtarr[4];
            $syntax_error_text=$filtarr[5];
    }
    else {
            $filter_error="error in filter engine: $filtarr[0]";
            print "$filter_error\n";
            exit;
    }
    if (length($limitord)) { 
          $limitexp=" order by $limitord limit $limitnum";
    }
    else {
          $limitexp="";
    }

    $sql="select ui_ir,ui_hazszam,upper(substring(ui_vezeteknev,1,3)),upper(substring(ui_keresztnev,-3)),upper(substring(ui_utca_nev,1,3)),id,upper(substring(ui_varos,1,3)) from users_$group_name where validated='yes' and ($filter_query) and robinson='no' and bounced='no' $limitexp";
    $sth = $dbh->prepare($sql);
    $sth->execute;

    print "$sql\n";

    $i = 0;

    $mfile="linea$filter_id";

    open (OO,">$mfile");

    while (@r = $sth->fetchrow_array) {
        $i++;
        if ($i/100 == int($i/100)) {
            print "$i\n";
        }
        $r[1] =~ s/[^0-9]//g;
        $vezeteknev=mx_voda_match($r[2],3," ","S");
        $keresztnev=mx_voda_match($r[3],3," ","S");
        $utcanev=mx_voda_match($r[4],3," ","S");
        $hazszam=mx_voda_match($r[1],-1," ","S");
        $ir=mx_voda_match($r[0],-1," ","S");
        $varos=mx_voda_match($r[6],-1," ","S");
        $id=$r[5];

        # 1. vezetéknév elsõ 3 karaktere
        # 2. keresztnév utolsó 3 karaktere
        # 3. utcanév elsõ 3 karaktere
        # 4. utca számmezõje
        # 5. irányítószám
        # 6. város elsõ 3 karaktere
        # (szokoz ha nem eleg hosszu)

		#$mc=$dbh->quote("$vezeteknev$keresztnev$utcanev$hazszam$ir$varos");
        $mc="$vezeteknev$keresztnev$utcanev$hazszam$ir$varos";
        # $dbh->do("insert into linea_match_permission (id,matchcode) values ($r[5],upper($mc))");
        print OO "$mc,$id\n";
    }
    close OO;
}

sub mx_voda_match($;$;$;$) {

    my $str=shift;
    my $stuffto=shift;
    my $stuffwith=shift;
    my $cclass=shift;

    if ($stuffto == -1) {
        ;
    }
    elsif (length($str)<$stuffto) {
        my $stf=$stuffto-length($str);
        for ($ij=0;$ij<$stf;$ij++) {
            if ($cclass eq "D") {
                $str = "$stuffwith$str";
            }
            else {
                $str = "$str$stuffwith";
            }
        }
    }
    return $str;
}

