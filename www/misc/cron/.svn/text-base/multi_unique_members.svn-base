#!/usr/bin/perl

use DBI;
use POSIX qw(strftime);

$_setchdir = $0;
$_setchdir =~ s/[^\/]*$//;
chdir($_setchdir);
require "./common.pl";

# run once after midnight
# this script calculates the number of unique members of the egyperces multigroup and saves it into a table
# TODO make this script capable of calculating the multigroup members for all (or some specific?) multigroups

$dbh = DBI->connect("DBI:mysql:$DB_NAME:$DB_AUTH_HOST:$DB_AUTH_PORT",$DB_AUTH_USER,$DB_AUTH_PW) || die $DBI::errstr ;
$dbh->{RaiseError} = 1;

@multis = (3);

for (@multis) {
    $multiid=$_;
    @union = ();
    $sth = $dbh->prepare("select g.title from multigroup mg,groups g where mg.groupid=g.id and mg.multiid='$multiid'");
    $sth->execute;
    while (@k = $sth->fetchrow_array) {
        push (@union,"select distinct ui_email from users_$k[0] where validated='yes' and robinson!='yes' and bounced='no'");
    }
    $sth->finish;
    $union_all=join(" union ",@union);
    $q="select count(*) from ($union_all) uall";
    #print "$q\n";
    $sth = $dbh->prepare($q);
    $sth->execute;
    if (@l = $sth->fetchrow_array) {
        $dbh->do("insert into multi_unique_members (multiid,members,date) values ('$multiid','$l[0]',now())")
    }
    $sth->finish;
}
